# 全球市场分析预设筛选修复指南

## 🎯 问题描述

修复全球市场分析中预设筛选选项与目标市场不匹配的问题。当选择美股时，不应该出现"沪深 300"等 A 股相关的预设选项。

## 🔧 修复内容

### 1. 核心问题分析

原始代码中的预设筛选选项是静态的，没有根据选择的市场类型动态更新。Streamlit 的组件状态管理需要特殊处理才能实现动态选项更新。

### 2. 修复的文件

#### 文件 1: `TradingAgents-CN/web/modules/enhanced_market_wide_analysis.py`

- **修复位置 1**: `_get_enhanced_preset_selector` 方法 (第 698-750 行)
- **修复位置 2**: fallback 配置表单 (第 180-205 行)

#### 文件 2: `TradingAgents-CN/web/components/market_analysis_components.py`

- **修复位置**: `_get_preset_selector` 方法 (第 284-325 行)

### 3. 技术实现要点

#### 关键技术 1: 动态 Key 策略

```python
# 使用市场类型作为key的一部分，确保市场变化时组件重新渲染
preset_key = f"{key_prefix}_preset_{market_type}"
```

#### 关键技术 2: 状态变化检测

```python
# 检查上一次的市场类型，如果发生变化则重置选择
last_market_key = f"{key_prefix}_last_market_type"
last_market = st.session_state.get(last_market_key)

if last_market != market_type:
    # 市场类型发生变化，重置为第一个选项
    st.session_state[last_market_key] = market_type
    if preset_key in st.session_state:
        del st.session_state[preset_key]
```

#### 关键技术 3: 预设选项映射

```python
preset_options = {
    "A股": ["沪深300", "中证500", "创业板50", "科创50", "自定义筛选"],
    "美股": ["标普500", "纳斯达克100", "道琼斯30", "罗素2000", "自定义筛选"],
    "港股": ["恒生指数", "恒生科技", "国企指数", "红筹指数", "自定义筛选"],
    "全球": ["全球大盘", "新兴市场", "发达市场", "科技巨头", "自定义筛选"]
}
```

## 🧪 测试步骤

### 测试 1: 增强版全球市场分析

1. 启动应用: `cd TradingAgents-CN && python start_web.py`
2. 访问 "🌍 全球市场分析" 页面
3. 在 "⚙️ 配置" 标签页中：
   - 选择 "🌍 目标市场" 为 "A 股"
   - 验证 "🎲 预设筛选" 显示: 沪深 300, 中证 500, 创业板 50, 科创 50 等
   - 选择 "🌍 目标市场" 为 "美股"
   - 验证 "🎲 预设筛选" 自动更新为: 标普 500, 纳斯达克 100, 道琼斯 30, 罗素 2000 等
   - 选择 "🌍 目标市场" 为 "港股"
   - 验证 "🎲 预设筛选" 自动更新为: 恒生指数, 恒生科技, 国企指数, 红筹指数 等

### 测试 2: Fallback 配置

1. 在增强版配置加载失败时，会显示简化配置表单
2. 同样测试市场类型切换时预设选项的动态更新

### 测试 3: 标准版市场分析

1. 如果增强版不可用，会回退到标准版
2. 标准版使用 `MarketConfigurationPanel` 组件，应该有相同的动态行为

## ✅ 预期结果

修复后的行为：

- **A 股**: 显示 沪深 300, 中证 500, 创业板 50, 科创 50, 上证 50, 深证 100, 中小板, ST 股票, 自定义筛选
- **美股**: 显示 标普 500, 纳斯达克 100, 道琼斯 30, 罗素 2000, 科技股, 成长股, 价值股, 分红股, 自定义筛选
- **港股**: 显示 恒生指数, 恒生科技, 国企指数, 红筹指数, 蓝筹股, 中概股, 生物科技, 房地产, 自定义筛选
- **全球**: 显示 全球大盘, 新兴市场, 发达市场, 科技巨头, ESG 投资, 商品期货, 货币市场, 自定义筛选

## 🔍 故障排除

### 问题 1: 预设选项仍然不更新

**解决方案**:

1. 清除浏览器缓存
2. 重启 Streamlit 应用
3. 检查浏览器控制台是否有 JavaScript 错误

### 问题 2: 选择的预设在切换市场后丢失

**解决方案**:
这是预期行为。当市场类型发生变化时，系统会自动重置预设选择为第一个选项，确保预设与市场类型匹配。

### 问题 3: 配置保存/加载功能受影响

**解决方案**:
配置保存/加载功能已经适配新的动态 key 策略，应该正常工作。如果有问题，检查 `market_config_store.py` 中的相关逻辑。

## 📝 技术说明

### Streamlit 组件状态管理

Streamlit 的 selectbox 组件在选项列表发生变化时，需要特殊处理：

1. 使用不同的 key 来强制组件重新渲染
2. 通过 session_state 跟踪状态变化
3. 在状态变化时清除旧的选择状态

### 向后兼容性

修复保持了向后兼容性：

- 如果市场类型不存在，默认使用 A 股选项
- 保留了所有原有的预设选项
- 不影响其他功能的正常使用

## 🎉 修复完成

现在用户在使用全球市场分析功能时，预设筛选选项将完全匹配所选择的目标市场，提供更加直观和准确的用户体验！
